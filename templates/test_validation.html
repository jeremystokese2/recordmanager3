{% extends 'base.html' %}
{% load validation_tags %}

{% block content %}
<div class="container mt-4">
    <h2>Record Type and Fields Validation</h2>
    
    <form method="post" enctype="multipart/form-data" class="mb-4">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="record_types_file" class="form-label">Record Types File</label>
                    <input type="file" class="form-control" id="record_types_file" name="record_types_file" accept=".json,.csv" required>
                    <div class="form-text">Accepted formats: JSON, CSV</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="record_fields_file" class="form-label">Record Fields File</label>
                    <input type="file" class="form-control" id="record_fields_file" name="record_fields_file" accept=".json,.csv" required>
                    <div class="form-text">Accepted formats: JSON, CSV</div>
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Validate Files</button>
    </form>

    {% if results %}
        <div class="mb-3">
            <h3>Validation Results</h3>
            
            <!-- Record Types Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <h4 class="mb-0">Record Types</h4>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="hideInactiveTypesToggle" checked>
                                <label class="form-check-label" for="hideInactiveTypesToggle">Hide inactive records</label>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="toggleAllTypes()">Expand/Collapse All</button>
                    </div>
                </div>
                <div class="card-body" id="typesSection">
                    {% for result in record_type_results %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center" 
                                 data-bs-toggle="collapse" 
                                 data-bs-target="#type{{ forloop.counter }}" 
                                 style="cursor: pointer;">
                                <div class="d-flex align-items-center gap-3">
                                    <h5 class="mb-0">{{ result.record }}</h5>
                                    {% if result.is_active is not None %}
                                        <span class="badge {% if result.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                            {{ result.is_active|yesno:"Active,Inactive" }}
                                        </span>
                                    {% endif %}
                                    <span class="badge {% if result.status == 'SUCCESS' %}bg-success{% elif result.status == 'FAILED' %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ result.status }}
                                    </span>
                                </div>
                                <!-- Add per-item stats -->
                                {% with item_stats=result.details|get_validation_stats %}
                                    <div class="d-flex gap-2">
                                        {% if item_stats.success > 0 %}<span class="badge bg-success">{{ item_stats.success }}</span>{% endif %}
                                        {% if item_stats.failed > 0 %}<span class="badge bg-warning">{{ item_stats.failed }}</span>{% endif %}
                                        {% if item_stats.error > 0 %}<span class="badge bg-danger">{{ item_stats.error }}</span>{% endif %}
                                        {% if item_stats.info > 0 %}<span class="badge bg-info">{{ item_stats.info }}</span>{% endif %}
                                        {% if item_stats.warning > 0 %}<span class="badge bg-warning text-dark">{{ item_stats.warning }}</span>{% endif %}
                                    </div>
                                {% endwith %}
                            </div>
                            
                            <div class="collapse" id="type{{ forloop.counter }}">
                                <div class="table-responsive mt-2">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Field</th>
                                                <th>Status</th>
                                                <th>Message</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        {% for check in result.details %}
                                            <tr>
                                                <td>{{ check.field }}</td>
                                                <td>
                                                    <span class="badge {% if check.status == 'SUCCESS' %}bg-success{% elif check.status == 'FAILED' %}bg-warning{% elif check.status == 'INFO' %}bg-info{% else %}bg-danger{% endif %}">
                                                        {{ check.status }}
                                                    </span>
                                                </td>
                                                <td>{{ check.message|safe }}</td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Record Fields Section -->
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <h4 class="mb-0">Record Fields</h4>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="hideInactiveFieldsToggle" checked>
                                <label class="form-check-label" for="hideInactiveFieldsToggle">Hide inactive records</label>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="toggleAllFields()">Expand/Collapse All</button>
                    </div>
                </div>
                <div class="card-body" id="fieldsSection">
                    {% regroup field_results by partition_key as grouped_fields %}
                    {% for group in grouped_fields %}
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2" 
                                 data-bs-toggle="collapse" 
                                 data-bs-target="#group{{ forloop.counter }}"
                                 style="cursor: pointer;">
                                <h5 class="mb-0">{{ group.grouper }}</h5>
                                <!-- Add group stats -->
                                {% with group_stats=group.list|get_validation_stats %}
                                    <div class="d-flex gap-2">
                                        {% if group_stats.success > 0 %}<span class="badge bg-success">{{ group_stats.success }}</span>{% endif %}
                                        {% if group_stats.failed > 0 %}<span class="badge bg-warning">{{ group_stats.failed }}</span>{% endif %}
                                        {% if group_stats.error > 0 %}<span class="badge bg-danger">{{ group_stats.error }}</span>{% endif %}
                                        {% if group_stats.info > 0 %}<span class="badge bg-info">{{ group_stats.info }}</span>{% endif %}
                                        {% if group_stats.warning > 0 %}<span class="badge bg-warning text-dark">{{ group_stats.warning }}</span>{% endif %}
                                    </div>
                                {% endwith %}
                            </div>
                            <div class="collapse show" id="group{{ forloop.counter }}">
                                {% for result in group.list %}
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center"
                                             data-bs-toggle="collapse"
                                             data-bs-target="#field{{ forloop.parentloop.counter }}{{ forloop.counter }}"
                                             style="cursor: pointer;">
                                            <div class="d-flex align-items-center gap-3">
                                                <h6 class="mb-0">{{ result.record }}</h6>
                                                {% if result.is_active is not None %}
                                                    <span class="badge {% if result.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                                        {{ result.is_active|yesno:"Active,Inactive" }}
                                                    </span>
                                                {% endif %}
                                                <span class="badge {% if result.status == 'SUCCESS' %}bg-success{% elif result.status == 'FAILED' %}bg-warning{% else %}bg-danger{% endif %}">
                                                    {{ result.status }}
                                                </span>
                                            </div>
                                            <!-- Add per-item stats -->
                                            {% with item_stats=result.details|get_validation_stats %}
                                                <div class="d-flex gap-2">
                                                    {% if item_stats.success > 0 %}<span class="badge bg-success">{{ item_stats.success }}</span>{% endif %}
                                                    {% if item_stats.failed > 0 %}<span class="badge bg-warning">{{ item_stats.failed }}</span>{% endif %}
                                                    {% if item_stats.error > 0 %}<span class="badge bg-danger">{{ item_stats.error }}</span>{% endif %}
                                                    {% if item_stats.info > 0 %}<span class="badge bg-info">{{ item_stats.info }}</span>{% endif %}
                                                    {% if item_stats.warning > 0 %}<span class="badge bg-warning text-dark">{{ item_stats.warning }}</span>{% endif %}
                                                </div>
                                            {% endwith %}
                                        </div>
                                        
                                        <div class="collapse" id="field{{ forloop.parentloop.counter }}{{ forloop.counter }}">
                                            <div class="table-responsive mt-2">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Check</th>
                                                            <th>Status</th>
                                                            <th>Message</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for check in result.details %}
                                                        <tr>
                                                            <td>{{ check.field }}</td>
                                                            <td>
                                                                <span class="badge {% if check.status == 'SUCCESS' %}bg-success{% elif check.status == 'FAILED' %}bg-warning{% elif check.status == 'INFO' %}bg-info{% else %}bg-danger{% endif %}">
                                                                    {{ check.status }}
                                                                </span>
                                                            </td>
                                                            <td>{{ check.message|safe }}</td>
                                                        </tr>
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const hideInactiveTypesToggle = document.getElementById('hideInactiveTypesToggle');
    const hideInactiveFieldsToggle = document.getElementById('hideInactiveFieldsToggle');
    
    hideInactiveTypesToggle.addEventListener('change', () => toggleInactiveRecords('types'));
    hideInactiveFieldsToggle.addEventListener('change', () => toggleInactiveRecords('fields'));
    
    // Initial hide of inactive records since toggles default to checked
    toggleInactiveRecords('types');
    toggleInactiveRecords('fields');
});

function toggleInactiveRecords(section) {
    const hideInactive = section === 'types' ? 
        document.getElementById('hideInactiveTypesToggle').checked :
        document.getElementById('hideInactiveFieldsToggle').checked;
    
    const sectionId = section === 'types' ? 'typesSection' : 'fieldsSection';
    const sectionElement = document.getElementById(sectionId);
    
    // Find all items in this section
    const items = sectionElement.querySelectorAll('.mb-3');
    
    items.forEach(item => {
        // Look for the Active/Inactive badge
        const badge = item.querySelector('.badge.bg-secondary');
        if (badge && badge.textContent.trim() === 'Inactive') {
            // If we find an inactive badge, hide/show the item
            item.style.display = hideInactive ? 'none' : '';
        }
    });
}

function toggleAllTypes() {
    const section = document.getElementById('typesSection');
    const collapses = section.querySelectorAll('.collapse');
    const isAnyCollapsed = Array.from(collapses).some(c => !c.classList.contains('show'));
    
    collapses.forEach(collapse => {
        if (isAnyCollapsed) {
            collapse.classList.add('show');
        } else {
            collapse.classList.remove('show');
        }
    });
}

function toggleFieldGroup(groupId) {
    const group = document.getElementById(groupId);
    if (group) {
        if (group.classList.contains('show')) {
            group.classList.remove('show');
        } else {
            group.classList.add('show');
        }
    }
}

function toggleAllFields() {
    const section = document.getElementById('fieldsSection');
    const collapses = section.querySelectorAll('.collapse');
    const isAnyCollapsed = Array.from(collapses).some(c => !c.classList.contains('show'));
    
    collapses.forEach(collapse => {
        if (isAnyCollapsed) {
            collapse.classList.add('show');
        } else {
            collapse.classList.remove('show');
        }
    });
}
</script>
{% endblock %} 